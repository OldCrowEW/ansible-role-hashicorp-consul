---
# tasks file for ansible-role-hashicorp-consul
- name: Read bootstrapped state
  stat:
    path: "{{ consul_bootstrap_state }}"
  register: bootstrap_state
  tags: always

- name: Ensure {{ consul_group }} group exists
  group:
    name: "{{ consul_group }}"
    state: present

- name: Ensure {{ consul_user }} user exists
  user:
    name: "{{ consul_user }}"
    shell: "{{ consul_user_shell }}"
    home: "{{ consul_run_dir }}"
    group: "{{ consul_group }}"
    system: "{{ consul_user_is_system }}"

- name: Include Hashicorp Consul install tasks
  include_tasks: "install-consul.yml"
  when: consul_gossip_encryption_enabled is true

- name: Ensure Hashicorp Consul {{ consul_conf_dir }} directory exists
  file:
    path: "{{ consul_conf_dir }}"
    mode: "{{ consul_conf_dir_mode }}"
    state: directory

- name: Copy Hashicorp {{ consul_config_file }} configuration
  template:
    src: "{{ consul_config_template }}"
    dest: "{{ consul_config_file }}"
    owner: "{{ consul_user }}"
    group: "{{ consul_group }}"
    mode: "{{ consul_config_mode }}"
  notify: restart-consul

- name: Include Hashicorp Consul gossip tasks
  include_tasks: "encrypt-gossip.yml"
  when: consul_gossip_encryption_enabled is true

- name: Ensure Hashicorp Consul {{ consul_confd_dir }} directory exists
  file:
    path: "{{ consul_confd_dir }}"
    owner: "{{ consul_user }}"
    group: "{{ consul_group }}"
    mode: "{{ consul_confd_dir_mode }}"
    state: directory

- name: Copy Hashicorp {{ consul_default_config }} configuration
  template:
    src: "{{ consul_sys_default_template }}"
    dest: "{{ consul_default_config }}"
    mode: "{{ consul_default_config_mode }}"
  notify: restart-consul
  when: ansible_distribution == 'Debian' or ansible_distribution == 'Ubuntu'

- name: Copy Hashicorp {{ consul_sysconfig }} configuration
  template:
    src: "{{ consul_sys_default_template }}"
    dest: "{{ consul_sysconfig }}"
    mode: "{{ consul_sysconfig_mode }}"
  notify: restart-consul
  when: ansible_distribution == 'CentOS' or ansible_distribution == 'Red Hat Enterprise Linux'

- name: Ensure Hashicorp Consul {{ consul_data_dir }} directory exists
  file:
    path: "{{ consul_data_dir }}"
    state: directory
    owner: "{{ consul_user }}"
    group: "{{ consul_group }}"
    mode: "{{ consul_data_dir_mode }}"

- name: Copy Hashicorp Consul Systemd Unit file
  template:
    src: "{{ consul_systemd_template }}"
    dest: "{{ consul_systemd_file }}"
    mode: "{{ consul_systemd_file_mode }}"
  notify: restart-consul

- meta: flush_handlers

- name: Ensure Hashicorp Consul is started and enabled
  service:
    name: "{{ consul_service }}"
    state: started
    enabled: true

- name: Create boostrapped state file
  file:
    dest: "{{ consul_bootstrap_state }}"
    state: touch
    mode: "600"
  when: not bootstrap_state.stat.exists

- name: Install dnsmasq for Hashicorp Consul Service Discovery via DNS
  include_tasks: "install-dnsmasq-{{ ansible_distribution }}.yml"
  when: dnsmasq_enabled is true
